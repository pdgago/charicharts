!function(){function a(a,b){return"translate("+[a,b]+")"}function b(a,b){var c,d;if(0!==a&&0!==b){if(d=Math.atan(b/a),d+=0>d?Math.PI/2:0,a>=0&&b>=0)c=d;else if(0>=a&&b>=0)c=d+Math.PI/2;else if(0>=a&&0>=b)c=d+Math.PI;else{if(!(a>=0&&0>=b))return;c=d+3*(Math.PI/2)}return c}}var c={version:"0.0.0"};String.prototype.format||(String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(b,c){return"undefined"!=typeof a[c]?a[c]:b})}),function(){var a=!1,b=/xyz/.test(function(){})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(c){function d(){return!a&&this.init?this.init.apply(this,arguments):void 0}var e=this.prototype;a=!0;var f=new this;a=!1;for(var g in c)f[g]="function"==typeof c[g]&&"function"==typeof e[g]&&b.test(c[g])?function(a,b){return function(){var c=this._super;this._super=e[a];var d=b.apply(this,arguments);return this._super=c,d}}(g,c[g]):c[g];return d.prototype=f,d.prototype.constructor=d,d.extend=arguments.callee,d}}.call(window);var d=Class.extend({init:function(a,b){return this.$scope={opts:this.parseOptions(a),data:b},_.extend(this.$scope,e()),this._loadModules(this._modules),_.extend(this.getInstanceProperties(),{on:this.$scope.on,unbind:this.$scope.unbind})},_loadModules:function(){for(var a=(this._generateInjector(this.$scope),0);a<this.modules.length;a++)_.extend(this.$scope,new this.modules[a](this.$scope))},_generateInjector:function(a){return function(b){var c=b[b.length-1];return b=b.slice(0,b.length-1).map(function(b){return a[b]}),c.apply(a,b)}}}),e=function(){var a={},b=a.c_||{};return a.trigger=function(c,d){for(var e=b[c],f=e?e.length:0;f--;)e[f].apply(a,d||[])},a.on=function(a,c){return b[a]||(b[a]=[]),b[a].push(c),[a,c]},a.unbind=function(a,c){var d=b[c?a:a[0]],e=d?d.length:0;for(c=c||a[1];e--;)d[e]===c&&d.splice(e,1)},a},f=Class.extend({_coreSubscriptions:[{"Scope/emit":function(a){_.each(a,function(a,b){this[b]&&(this[b]=a)},this)}}],init:function(a){return this._loadModules(a),_.each(_.union(this._coreSubscriptions,this._subscriptions),this._subscribe,this),this.initialize()},_loadModules:function(a){for(var b=this.deps.length-1;b>=0;b--)this[this.deps[b]]=a[this.deps[b]];this.on=a.on,this.trigger=a.trigger},_subscribe:function(a){_.each(a,_.bind(function(a,b){this.on(b,_.bind(a,this))},this))},emit:function(a){this.trigger("Scope/emit",[a])}}),g=f.extend({deps:["svg","opts","xscale","yscale"],_subscriptions:[{"Scale/updated":function(){_.each(this._status.axes,this._updateAxis,this)}}],initialize:function(){this._status={axes:this._initAxesModel()},_.each(this._status.axes,this._renderAxis,this)},_renderAxis:function(a,b){switch(b){case"bottom":this._renderBottom(a);break;case"left":this._renderLeft(a);break;case"right":this._renderRight(a)}this._afterAxisChanges()},_renderTop:function(){},_renderBottom:function(a){a.axis=d3.svg.axis().scale(this.xscale).orient("bottom").tickSize(this.opts.height).tickFormat(this.opts.xaxis.bottom.tickFormat),a.el=this.svg.append("g").attr("class","xaxis bottom").call(a.axis)},_renderLeft:function(a){a.axis=d3.svg.axis().scale(this.yscale).orient("left").tickSize(-this.opts.width).tickPadding(this.opts.margin.left).tickFormat(this.opts.yaxis.left.tickFormat),a.el=this.svg.append("g").attr("class","yaxis left").call(a.axis)},_renderRight:function(a){a.axis=d3.svg.axis().scale(this.yscale).orient("right").tickSize(this.opts.width).tickPadding(0).tickFormat(this.opts.yaxis.right.tickFormat),a.el=this.svg.append("g").attr("class","yaxis right").call(a.axis)},_updateAxis:function(a,b){var c="top"===b||"bottom"===b?this.xscale:this.yscale;a.el.transition().duration(500).ease("linear").call(a.axis.scale(c)),this._afterAxisChanges(a)},_initAxesModel:function(){var a={},b={top:this.opts.xaxis.top.enabled,right:this.opts.yaxis.right.enabled,bottom:this.opts.xaxis.bottom.enabled,left:this.opts.yaxis.left.enabled};return _.each(b,function(b,c){b&&(a[c]={})}),a},_afterAxisChanges:function(){this.svg.select(".yaxis .domain").remove(),this.svg.select(".xaxis .domain").remove(),this.svg.selectAll(".yaxis.left text").style("text-anchor","start","important"),this.svg.selectAll(".yaxis.right text").style("text-anchor","end","important").attr("transform",a(this.opts.margin.right,this.opts.yaxis.textMarginTop)),this.opts.yaxis.textMarginTop&&this.svg.selectAll(".yaxis.left text").attr("transform",a(0,this.opts.yaxis.textMarginTop)),this.opts.yaxis.fullGrid&&this.svg.selectAll(".yaxis line").attr("transform",a(+this.opts.margin.left,0)).attr("x1",2*-this.opts.margin.left),this.svg.selectAll(".yaxis line").each(function(a){0===a&&d3.select(this).attr("class","zeroline")})}}),h=f.extend({deps:["svg","opts","data"],initialize:function(){switch(this.opts.gridTicks&&this._renderGrid(),this.opts.orientation){case"vertical":this._renderVertical();break;case"horizontal":this._renderHorizontal()}return this._setEvents(),{path:this.path}},_setEvents:function(){var a=this;this.path.on("mouseover",function(b){a.path.style("opacity",a.opts.hoverFade),d3.select(this).style("opacity",1),a.on("Bar-piece/mouseover",[b])}),this.svg.on("mouseleave",function(){a.path.style("opacity",1)})},_renderHorizontal:function(){var a=d3.sum(_.pluck(this.data,"value")),b=0,c=_.map(this.data,function(c){var d={x0:b,x1:100*c.value/a,color:c.color};return b+=d.x1,d});this.path=this.svg.selectAll("rect").data(c).enter().append("rect").attr("x",function(a){return a.x0+"%"}).attr("y",0).attr("width",function(a){return a.x1+"%"}).attr("height",this.opts.fullHeight).style("fill",function(a){return a.color})},_renderVertical:function(){var a=d3.sum(_.pluck(this.data,"value")),b=0,c=_.map(this.data,function(c){var d={y0:b,y1:100*c.value/a,color:c.color};return b+=d.y1,d});this.path=this.svg.selectAll("rect").data(c).enter().append("rect").attr("x",0).attr("y",function(a){return a.y0+"%"}).attr("width",this.opts.width).attr("height",function(a){return a.y1+"%"}).style("fill",function(a){return a.color})},_renderGrid:function(){var b=this.opts.fullHeight/(this.opts.gridTicks-1)-1/this.opts.gridTicks;this.grid=this.svg.append("g").attr("transform",a(-this.opts.margin.left,-this.opts.margin.top)).attr("class","grid");for(var c=0;c<this.opts.gridTicks;c++)this.grid.append("line").attr("x1",0).attr("x2",this.opts.fullWidth).attr("y1",b*c).attr("y2",b*c).attr("stroke","red")}}),i=f.extend({deps:["opts","svg","path","arc"],_subscriptions:[{"Pie-piece/mouseover":function(a){this._moveArrow(a)}},{"Pie/updated":function(){this._update()}}],initialize:function(){if(this.opts.innerArrow){var a=this;return this._drawArrow(),setTimeout(function(){var b=a.path.data()[0];a.moveArrowToId(b.data.id)},0),{moveArrowToId:_.bind(this.moveArrowToId,this)}}},_drawArrow:function(){var a=this.opts.radius*this.opts.innerArrowSize*(1-this.opts.innerRadius);this.svg.append("svg:marker").attr("id","innerArrow").attr("viewBox","0 {0} {1} {2}".format(-(a/2),a,a)).attr("refX",this.opts.radius*(1-this.opts.innerRadius)+5).attr("refY",0).attr("fill","white").attr("markerWidth",a).attr("markerHeight",a).attr("orient","auto").append("svg:path").attr("d","M0,{0}L{1},0L0,{2}".format(-(a/2),a,a/2)),this.innerArrow=this.svg.append("svg:line").attr("x1",0).attr("y1",0).attr("x2",this.opts.radius).attr("y2",0).attr("class","inner-arrow").style("stroke","transparent").attr("marker-end","url(#innerArrow)")},_moveArrow:function(a){var c=this.arc.centroid(a),d=b.apply(this,c),e=d*(180/Math.PI);this.innerArrow.transition().duration(200).attr("transform","translate(0) rotate("+e+")"),this._current=a,this.trigger("Pie-arrow/moved",[a])},moveArrowToId:function(a){var b=this;this.path.each(function(c){c.data.id===a&&b._moveArrow(c)})},_update:function(){this._current&&this.moveArrowToId(this._current.data.id)}}),j=f.extend({deps:["svg","opts","data"],_subscriptions:[{}],initialize:function(){return this.pie=d3.layout.pie().value(function(a){return a.value}).sort(null),this.arc=d3.svg.arc().innerRadius(this.opts.radius*this.opts.innerRadius).outerRadius(this.opts.radius),this.path=this.svg.selectAll("path"),this.update(),this._setEvents(),{update:_.bind(this.update,this),path:this.path,arc:this.arc}},update:function(){function a(a){var c=d3.interpolate(this._current,a);return this._current=c(0),function(a){return b.arc(c(a))}}var b=this,c=this.pie(this.data);this.path=this.path.data(c),this.path.enter().append("path").each(function(a){this._current=a}).attr("class","pie-piece"),this.path.attr("fill",function(a){return a.data.color}),this.path.exit().remove();var d=0;this.path.transition().duration(300).attrTween("d",a).each(function(){++d}).each("end",function(){--d||b.trigger("Pie/updated",[])})},_setEvents:function(){var a=this;this.path.on("mouseover",function(b){a.path.exit(),a.path.style("opacity",a.opts.hoverFade),d3.select(this).style("opacity",1),a.trigger("Pie-piece/mouseover",[b])}),this.svg.on("mouseleave",function(){a.path.style("opacity",1)})}}),k=f.extend({deps:["opts","data"],_d3Scales:{time:d3.time.scale.utc,ordinal:d3.scale.ordinal,linear:d3.scale.linear},_subscriptions:[{"Serie/update":function(){this._setScales(),this.emit({xscale:this.xscale,yscale:this.yscale}),this.trigger("Scale/updated",[])}}],initialize:function(){return this._setScales(),{xscale:this.xscale,yscale:this.yscale}},_getScale:function(a){var b=this.opts[a+"axis"],c=this._getExtent(a,b.fit),d="x"===a?[0,this.opts.width]:[this.opts.height,0];return this._d3Scales[b.scale]().domain(c).range(d)},_getExtent:function(a,b){var c=d3.extent(this._dataFlattened,function(b){return b[a]});if(b)return c;if(c[0]>=0)return[0,c[1]];var d=Math.abs(c[0]),e=Math.abs(c[1]),f=d>e?d:e;return[-f,f]},_setFlattenedData:function(){this._dataFlattened=_.flatten(_.map(this.data,function(a){return"bar"===a.type?_.flatten(_.pluck(a.data,"values")):a.values}))},_setScales:function(){this._setFlattenedData(),this.xscale=this._getScale("x"),this.yscale=this._getScale("y")}}),l=f.extend({deps:["data","svg","xscale","yscale","opts"],_subscriptions:[],initialize:function(){return this._status={series:{}},_.each(this.data,this._renderSerie,this),{update:_.bind(this.updateSeries,this),addSerie:_.bind(this.addSerie,this),removeSerie:_.bind(this.removeSerie,this)}},addSerie:function(a){this.data.push(a),this.emit({data:this.data}),this.trigger("Serie/update",[]),this._renderSerie(a)},removeSerie:function(a){var b=_.findWhere(this.data,{id:a});this.data.splice(this.data.indexOf(b),1),this._status.series[a].el.remove(),this._status.series=_.omit(this._status.series,a),this.trigger("Serie/update",[])},_renderSerie:function(a){switch(a.type){case"line":this._renderLineSerie(a);break;case"bar":this._renderBarSerie(a);break;case"area":this._renderAreaSerie(a)}},updateSeries:function(){this.trigger("Serie/update",[]),_.each(this._status.series,_.bind(function(a){switch(a.el.attr("type")){case"line":this._updateLineSerie(a);break;case"bar":this._updateBarSerie(a);break;case"area":this._updateAreaSerie(a)}},this))},_renderLineSerie:function(a){var b=this.svg.append("path").datum(a.values).attr("id","serie-"+a.id).attr("class","serie-line").attr("stroke",a.color).attr("type","line").attr("active",1),c={el:b,data:a};a.dots&&(c.dots=this.svg.append("g").attr("id","serie-"+a.id+"-dots").selectAll(".dot")),this._status.series[a.id]=c,this._updateLineSerie(c)},_updateLineSerie:function(a){var b=this._getLineFunc();a.el.attr("d",b.interpolate(a.data.interpolation)),a.data.dots&&(a.dots=a.dots.data(a.data.values.filter(function(a){return a.y})),a.dots.enter().append("circle").attr("class","dot"),a.dots.exit().remove(),a.dots.attr("cx",b.x()).attr("cy",b.y()).attr("fill",a.data.color).attr("stroke",a.data.color).attr("stroke-width","2px").attr("r",3))},_getLineFunc:function(){var a=this;return d3.svg.line().defined(function(a){return!!a.y}).x(function(b){return a.xscale(b.x)}).y(function(b){return a.yscale(b.y)})},_renderBarSerie:function(a){var b=this;console.log(a.data);var c=_.groupBy(_.flatten(_.pluck(a.data,"values")),"x");_.each(c,function(a){var b=0,c=0;return _.each(a,function(a){return a.y<0?(a.y0=c,c=a.y-c,a.y1=c):(a.y0=b,a.y1=b+=a.y),a}),a});{var d=this.svg.selectAll(".serie-bar").data(a.data).enter().append("g").attr("class","serie-bar").style("fill",function(a){return a.color});d.selectAll("rect").data(function(a){return a.values}).enter().append("rect").attr("x",function(a){return b.xscale(a.x)}).attr("y",function(a){return b.yscale(a.y1)}).attr("width",12).attr("height",function(a){return b.yscale(a.y0)-b.yscale(a.y1)})}},_updateBarSerie:function(){}}),m=f.extend({deps:["opts"],initialize:function(){return this.svg=this.drawSvg(),{svg:this.svg}},drawSvg:function(){return d3.select(this.opts.target).append("svg").attr("width",this.opts.fullWidth).attr("height",this.opts.fullHeight).append("g").attr("class","g-main").attr("transform",this.opts.gmainTranslate)}}),n=f.extend({deps:["svg","opts","xscale","data"],_subscriptions:[{"Scale/updated":function(){this._status.x&&this._moveToValue(this._status.xvalue)}}],initialize:function(){var a=this;this.opts.trail.enabled&&(this._status={xvalue:null,x:null},this._renderTrail(),setTimeout(function(){a._moveToValue(a.opts.trail.initXvalue(a.xscale))},0))},_renderTrail:function(){{var b=this.svg.append("g").attr("class","trail");this.svg.append("svg:marker").attr("id","trailArrow").attr("viewBox","0 0 20 20").attr("refX","15").attr("refY","11").attr("markerUnits","strokeWidth").attr("markerWidth","15").attr("markerHeight","11").attr("orient","auto").append("svg:path").attr("class","trail-arrow").attr("d","M 0 0 L 20 10 L 0 20 z").attr("fill","#777")}this.trailLine=b.append("svg:line").attr("class","trail-line").attr("x1",0).attr("x2",0).attr("y1",0).attr("y2",this.opts.height).attr("marker-start","url(#trailArrow)"),this.brush=d3.svg.brush().x(this.xscale).extent([0,0]),this.bisector=d3.bisector(function(a){return a.x}).left,this.sliderZone=this.svg.append("g").attr("transform",a(0,0)).attr("class","trail-slider-zone").call(this.brush),this.sliderZone.select(".background").attr("height",this.opts.height).attr("width",this.opts.width).style("cursor","pointer"),this.svg.selectAll(".extent,.resize").remove(),this._setEvents()},_setEvents:function(){var a=this;this.brush.on("brush",function(){a._onBrush(this)})},_onBrush:function(a){var b;b=d3.event.sourceEvent?this.xscale.invert(d3.mouse(a)[0]):brush.extent()[0],this._moveToValue(b)},_moveToValue:function(a){var b=this.xscale.domain(),c=!!a.getMonth;c?Date.parse(a)>Date.parse(b[1])?a=b[1]:Date.parse(a)<Date.parse(b[0])&&(a=b[0]):a>b[1]?a=b[1]:a<b[0]&&(a=b[0]),a=this.opts.trail.beforeMove(a);var d=Math.round(this.xscale(a)-1);if(d!==this._status.x){var e=this._getDataFromValue(a);this._status.x=d,this._status.xvalue=a,this._moveTrail(d),this.trigger("Trail/changed",[e,a])}},_getDataFromValue:function(a){return _.map(this.data,function(b){return _.extend(b.values[this.bisector(b.values,a)],{id:b.id})},this)},_moveTrail:function(a){this.trailLine.attr("x1",a).attr("x2",a)}});c.Chart=d.extend({modules:[m,k,g,l,n],getInstanceProperties:function(){return _.pick(this.$scope,"update","addSerie","removeSerie")},defaults:{margin:"0,0,0,0",trail:{enabled:!1,beforeMove:function(a){return a},initXvalue:function(a){return a.domain()[1]}},xaxis:{scale:"time",fit:!0,ticks:!1,top:{enabled:!1,label:!1,tickFormat:function(a){return a}},bottom:{enabled:!0,label:!1,tickFormat:function(a){return a}}},yaxis:{scale:"linear",fit:!1,fullGrid:!0,textMarginTop:0,ticks:!1,left:{enabled:!0,label:!1,tickFormat:function(a){return a}},right:{enabled:!1,label:!1,tickFormat:function(a){return a}}}},parseOptions:function(b){var c=_.extend({},this.defaults,b);return c.trail=_.extend({},this.defaults.trail,c.trail),c.xaxis=_.extend({},this.defaults.xaxis,c.xaxis),c.xaxis.bottom=_.extend({},this.defaults.xaxis.bottom,c.xaxis.bottom),c.xaxis.top=_.extend({},this.defaults.xaxis.top,c.xaxis.top),c.yaxis=_.extend({},this.defaults.yaxis,c.yaxis),c.yaxis.left=_.extend({},this.defaults.yaxis.left,c.yaxis.left),c.yaxis.right=_.extend({},this.defaults.yaxis.right,c.yaxis.right),c.margin=_.object(["top","right","bottom","left"],c.margin.split(" ").map(Number)),(c.yaxis.left.label||c.yaxis.right.label)&&(c.margin.top+=Math.abs(c.yaxis.textMarginTop-30)),c.fullWidth=c.target.offsetWidth,c.fullHeight=c.target.offsetHeight,c.width=c.fullWidth-c.margin.left-c.margin.right,c.height=c.fullHeight-c.margin.top-c.margin.bottom,c.gmainTranslate=a(c.margin.left,c.margin.top),c}}),c.PercentageBar=d.extend({modules:[m,h],getInstanceProperties:function(){var a={};return a},defaults:{margin:"0 0 0 0",orientation:"horizontal",hoverFade:.6,gridTicks:0},parseOptions:function(b){var c=_.extend({},this.defaults,b);c.margin=_.object(["top","right","bottom","left"],c.margin.split(" ").map(Number));var d=!c.margin.left&&!c.margin.right;return c.fullWidth=d?"100%":c.target.offsetWidth,c.fullHeight=c.target.offsetHeight,d||(c.width=c.fullWidth-c.margin.left-c.margin.right),c.height=c.fullHeight-c.margin.top-c.margin.bottom,c.gmainTranslate=a(c.margin.left,c.margin.top),console.log(c),c}}),c.Pie=d.extend({modules:[m,j,i],getInstanceProperties:function(){var a={update:this.$scope.update};return this.$scope.moveArrowToId&&(a.moveArrowToId=this.$scope.moveArrowToId),a},defaults:{margin:"0 0 0 0",innerRadius:.6,hoverFade:1,innerArrow:!1,innerArrowSize:.5},parseOptions:function(b){var c=_.extend({},this.defaults,b);return c.margin=_.object(["top","right","bottom","left"],c.margin.split(" ").map(Number)),c.fullWidth=c.target.offsetWidth,c.fullHeight=c.target.offsetHeight,c.width=c.fullWidth-c.margin.left-c.margin.right,c.height=c.fullHeight-c.margin.top-c.margin.bottom,c.gmainTranslate=a(c.fullWidth/2,c.fullHeight/2),c.radius=Math.min(c.fullWidth,c.fullHeight)/2,c}}),"function"==typeof define&&define.amd?define(c):"object"==typeof module&&module.exports&&(module.exports=c),this.Charicharts=c}.call(window);