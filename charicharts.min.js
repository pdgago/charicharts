!function(){"use strict";function a(a,b){return"translate("+a+","+b+")"}function b(a){return a.margin=_.object(["top","right","bottom","left"],a.margin.split(",").map(Number)),a.fullWidth=a.target.offsetWidth,a.fullHeight=a.target.offsetHeight,a.width=a.fullWidth-a.margin.left-a.margin.right,a.height=a.fullHeight-a.margin.top-a.margin.bottom,a}function c(a){var b=a.node(),c=b.getBBox(),d=[c.x+c.width/2,c.y+c.height/2];return d}function d(a,b){function c(a){return[{}].concat(_.map(e,function(b){return b[a]}))}var d=a[0],e=Array.prototype.slice.call(a,1);return _.each(e,function(a){for(var e in a)d[e]=_.indexOf(b,e)>=0?_.extend.apply(this,c(e)):a[e]}),d}function e(a,b){var c,d;if(0!==a&&0!==b){if(d=Math.atan(b/a),d+=0>d?Math.PI/2:0,a>=0&&b>=0)c=d;else if(0>=a&&b>=0)c=d+Math.PI/2;else if(0>=a&&0>=b)c=d+Math.PI;else{if(!(a>=0&&0>=b))return;c=d+3*(Math.PI/2)}return c}}var f={version:"0.0.0"};String.prototype.format||(String.prototype.format=function(){var a=arguments;return this.replace(/{(\d+)}/g,function(b,c){return"undefined"!=typeof a[c]?a[c]:b})}),f.Events=function(a){var b=a.c_||{},c=function(c,d){for(var e=b[c],f=e?e.length:0;f--;)e[f].apply(a,d||[])},d=function(a,c){return b[a]||(b[a]=[]),b[a].push(c),[a,c]},e=function(a,c){var d=b[c?a:a[0]],e=d?d.length:0;for(c=c||a[1];e--;)d[e]===c&&d.splice(e,1)};return{trigger:c,on:d,unbind:e}};var g=function(a){return function(b){var c=b[b.length-1];return b=b.slice(0,b.length-1).map(function(b){return a[b]}),c.apply(a,b)}};f.Chart=function(a){this._options=this.parseOptions(a),this.$scope=_.extend({},this._options,f.Events(this)),this.load=g(this.$scope),this.renderChart();var b={on:this.$scope.on,toggleSerie:_.bind(this.toggleSerie,this),addSerie:_.bind(this.addSerie,this)};return b},f.Chart.prototype.renderChart=function(){var b=this._options,c=this,d=a(b.margin.left,b.margin.top);this.$scope.svg=this.load(n).draw(d),b.xaxis.enabled&&(this.$scope.xscale=this.load(l).getXScale(),this.$scope.xaxis=this.load(h).drawAxis()),b.yaxis.enabled&&(this.$scope.yscale=this.load(l).getYScale(),this.$scope.yaxis=this.load(i).drawAxis()),_.each(b.data,function(a){c.addSerie(a)}),b.trail&&b.xaxis.enabled&&this.load(o),this.$scope.svg.selectAll(".domain").remove()},f.Chart.prototype.addSerie=function(a){"line"===a.type?this.load(k).drawLine(a):"bar"===a.type?this.load(j).drawBar(a):"stacked-bar"===a.type&&this.load(m).drawBar(a)},f.Chart.prototype.toggleSerie=function(a){var b=this.$scope.svg.select("#serie"+a);if(!b.empty()){var c=Number(b.attr("active"))?0:1;b.attr("active",c),b.transition().duration(200).style("opacity",b.attr("active"))}},f.Chart.prototype.parseOptions=function(a){return a=d([{},f.Chart.defaults,a],["series","yaxis","xaxis"]),a.margin=_.object(["top","right","bottom","left"],a.margin.split(",").map(Number)),a.fullWidth=a.target.offsetWidth,a.fullHeight=a.target.offsetHeight,a.width=a.fullWidth-a.margin.left-a.margin.right,a.height=a.fullHeight-a.margin.top-a.margin.bottom,a},f.Chart.defaults={margin:"0,0,0,0",trail:!1,series:{barWidth:10,align:"left"},xaxis:{scale:"time",ticks:!1,fit:!1,orient:"bottom",enabled:!0,tickFormat:function(a){return a instanceof Date?a.getHours():a}},yaxis:{scale:"linear",fit:!1,enabled:!0,orient:"left",textAnchor:"end",textMarginTop:0,tickFormat:function(a,b){return b?a:void 0}}},f.Pie=function(a){return this._options=b(_.extend({},f.Pie.defaults,a)),this.$scope=_.extend({},this._options,f.Events(this)),this.load=g(this.$scope),this.init(),_.pick(this.$scope,"on")},f.Pie.prototype.init=function(){var b=this.$scope,c=this._options;b.radius=Math.min(c.fullWidth,c.fullHeight)/2,b.svg=this.load(n).draw(a(c.fullWidth/2,c.fullHeight/2)),c.outerBorder&&b.svg.append("svg:circle").attr("class","outer-border").attr("fill","transparent").attr("cx",0).attr("cy",0).attr("r",b.radius),b.pieLayout=d3.layout.pie().sort(null).value(function(a){return a.value});var d=c.outerBorder?1-c.outerBorder:1,e=b.radius*d;b.arc=d3.svg.arc().innerRadius(e-e*(1-c.innerRadius)).outerRadius(e),b.pieces=b.svg.selectAll("path").data(b.pieLayout(c.data)).enter().append("path").attr("class","pie-piece").attr("fill",_.bind(function(a){return a.data.color},this)).attr("d",b.arc),b.pieces.on("mouseover",function(a){b.pieces.style("opacity",c.fadeOpacity),d3.select(this).style("opacity",1),b.trigger("mouseover",[a])}),b.svg.on("mouseleave",function(){b.pieces.style("opacity",1)}),c.innerArrow&&this.setInnerArrow()},f.Pie.prototype.setInnerArrow=function(){function a(a){var b=Math.cos(a),c=Math.sin(a),d=g*b,e=g*c;d&&e&&f.innerArrow.attr("x2",d).attr("y2",e)}function b(b){b.each(function(a){f.trigger("mouseover",[a])});var d=c(b);a(e.apply(this,d))}var d=this._options,f=this.$scope,g=f.radius*(1-d.outerBorder),h=g*d.innerArrowSize*(1-d.innerRadius),i=g*d.innerRadius*2;h>i&&(h=.5*i),f.svg.append("svg:marker").attr("id","innerArrow").attr("viewBox","0 {0} {1} {2}".format(-(h/2),h,h)).attr("refX",g*(1-d.innerRadius)+5).attr("refY",0).attr("fill","white").attr("markerWidth",h).attr("markerHeight",h).attr("orient","auto").append("svg:path").attr("d","M0,{0}L{1},0L0,{2}".format(-(h/2),h,h/2)),f.innerArrow=f.svg.append("line").attr("class","outer-border").style("stroke","transparent").attr("x1",0).attr("x2",0).attr("y1",0).attr("y2",0).attr("marker-end","url(#innerArrow)"),f.pieces.on("mousemove",function(){var b=d3.mouse(this),c=e(b[0],b[1]);a(c)}),setTimeout(function(){b(d3.select(f.pieces[0][0]))},0)},f.Pie.defaults={margin:"0,0,0,0",innerRadius:.5,outerBorder:.1,fadeOpacity:1,innerArrow:!1,innerArrowSize:.6};var h=["xscale","xaxis","svg","height",function(b,c,d,e){var f=d3.svg.axis().scale(b).orient(c.orient).tickFormat(c.tickFormat);return c.ticks&&f.ticks.apply(f,c.ticks),f.drawAxis=function(){var b="bottom"===c.orient?e:0;return d.append("g").attr("class","xaxis").attr("transform",a(0,b)).call(f).selectAll("text").style("text-anchor","middle"),f},f}],i=["yscale","yaxis","width","svg","margin",function(b,c,d,e,f){var g=d3.svg.axis().scale(b).orient(c.orient).tickSize(-d).tickFormat(c.tickFormat);return g.drawAxis=function(){e.append("g").attr("class","yaxis").attr("transform",a(0,0)).call(g).selectAll("text").attr("x",-f.left).attr("y",c.textMarginTop).style("text-anchor",c.textAnchor),e.select(".yaxis").selectAll("line").attr("x1",-f.left).attr("x2",d+(f.right||0)).each(function(a){0===a&&d3.select(this).attr("class","zeroline")})},g}],j=["svg","xscale","yscale","height","series",function(a,b,c,d,e){function f(d){a.append("g").attr("id","serie"+d.id).attr("active",1).attr("class","bar").selectAll("rect").data(d.values).enter().append("rect").attr("class",function(a){return a.value<0?"bar-negative":"bar-positive"}).attr("x",function(a){return b(a.datetime)-e.barWidth/2}).attr("y",function(a){return c(a.value<0?0:a.value)}).attr("width",e.barWidth).attr("height",function(a){return Math.abs(c(a.value)-c(0))}).attr("fill",function(){return d.color})}return{drawBar:f}}],k=["svg","xscale","yscale",function(a,b,c){function d(b){var c=a.append("path").attr("id","serie"+b.id).attr("active",1).attr("class","line").attr("transform","translate(0, 0)").attr("stroke",b.color).attr("d",e.interpolate(b.interpolation)(b.values));c.on("mousemove",function(){console.log("mouse over")})}var e=d3.svg.line().x(function(a){return b(a.datetime)}).y(function(a){return c(a.value)});return{drawLine:d}}],l=["data","xaxis","yaxis","width","height",function(a,b,c,d,e){function f(){return d3.extent(n,function(a){return a.datetime})}function g(){var a=d3.extent(n,function(a){return Number(a.value)*l});if(a[0]>=0)return[0,a[1]];var b=Math.abs(a[0]),c=Math.abs(a[1]),d=b>c?b:c;return[-d,d]}function h(){return d3.extent(n,function(a){return a.value*l})}function i(a,b){return"time"===a?f():b?h():g()}function j(){var a=i(b.scale,b.fit);return m[b.scale]().domain(a).range([0,d])}function k(){var a=i(c.scale,c.fit);return m[c.scale]().domain(a).range([e,0]).nice()}var l=1.05,m={time:d3.time.scale,ordinal:d3.scale.ordinal,linear:d3.scale.linear},n=_.flatten(_.map(a,function(a){return a.values}));return{getXScale:j,getYScale:k}}],m=["svg","yscale","xscale","trigger","series","width",function(b,c,d,e,f,g){function h(h){var i=0;h.values.forEach(function(a){a.forEach(function(a){a.y0=i,a.y1=i+=Math.max(0,a.value)})});var j=b.selectAll("stacked-bar").data(h.values).enter().append("g").attr("transform",function(b){var c;return d?d[b.datetime||b.value]:c="right"===f.align?g-f.barWidth:0,a(c,0)});j.selectAll("rect").data(function(a){return a}).enter().append("rect").attr("width",f.barWidth).attr("y",function(a){return c(a.y1)}).attr("height",function(a){return c(a.y0)-c(a.y1)}).style("fill",function(a){return a.color}).on("mouseover",function(a){e("mouseoverStackbar",[a])})}return{drawBar:h}}],n=["fullWidth","fullHeight","target",function(a,b,c){function d(d){return d3.select(c).append("svg").attr("width",a).attr("height",b).append("g").attr("class","g-main").attr("transform",d)}return{draw:d}}],o=["svg","trigger","height","width","xscale",function(b,c,d,e,f){function g(){var a,b=f.domain();if(a=d3.event.sourceEvent?f.invert(d3.mouse(this)[0]):l.extent()[0],Date.parse(a)>Date.parse(b[1])&&(a=b[1]),Date.parse(a)<Date.parse(b[0])&&(a=b[0]),a.getMinutes()>=-30&&a.setHours(a.getHours()),a.setMinutes(0,0),Date.parse(i)!==Date.parse(a)){i=a;var d=Math.round(f(a))-1;h(d),c("moveTrail",[a])}}function h(a){k.attr("x1",a).attr("x2",a)}var i,j=b.append("g").attr("class","trail"),k=j.append("svg:line").attr("class","trail-line").attr("x1",0).attr("x2",0).attr("y1",0).attr("y2",d),l=d3.svg.brush().x(f).extent([0,0]),m=b.append("g").attr("transform",a(0,0)).attr("class","trail-slider").call(l);m.select(".background").attr("height",d).attr("width",e).style("cursor","pointer"),b.selectAll(".extent,.resize").remove(),l.on("brush",g),setTimeout(function(){m.call(l.extent([new Date,new Date])).call(l.event)},0)}];"function"==typeof define&&define.amd?define(f):"object"==typeof module&&module.exports&&(module.exports=f),this.Charicharts=f}.call(window);